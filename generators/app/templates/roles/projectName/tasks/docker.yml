--- # tasks/docker.yml

- name: install docker-compose config
  template: src=templates/docker-compose.yml.j2 dest={{ install_path }}/docker-compose.yml
  become: true
  notify:
  - restart docker services

- name: install systemd service
  template: src=templates/systemd.service.j2
            dest=/etc/systemd/system/{{ service_name }}.service
            mode=0600 owner=root group=root
  become: true

- name: reiinstall packages inplace, if needed
  pip: name={{ item}} state=latest extra_args=-I
  become: true
  with_items:
  - chardet
  - urllib3
  - requests

- name: update pip to latest
  pip: name={{ item }} state=latest
  become: true
  with_items:
  - setuptools
  - pip

- name: install docker python bindings
  pip: name={{ item }} state=present
  become: true
  with_items:
    - docker-py==1.10.6
    - docker-compose==1.9.0

- name: login to registry
  docker_login: registry={{ docker_registry }} state=present
                username={{ docker_username }} password={{ docker_password }}
  become: true
  changed_when: false
  notify:
  - restart docker services

- name: pull latest repo
  docker_container: name=app-dot pull=yes image={{ docker_repo }}:{{ docker_tag }}
                    state=present
  become: true
  notify:
  - restart docker services
  - migrate
  - collectstatic

- name: logout of registry
  docker_login: registry={{ docker_registry }} state=absent
  become: true
  notify:
  - restart docker services
